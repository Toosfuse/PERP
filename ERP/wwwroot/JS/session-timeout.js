/**
 * Global AJAX Session Timeout Handler
 * ??? ??????? ???? AJAX requests ?? ?????? ?????? ? ?? ???? ????????? session
 * ????? ?? ?? ???? ????? ????? ??????
 */

$(document).ready(function () {
    // ????? AJAX ??????? ?? token ?? CSRF ????? ?????? ??????? ???
    var token = $('input[name="__RequestVerificationToken"]').val();
    
    $.ajaxSetup({
        beforeSend: function (xhr, settings) {
            // ?????????? token ?? CSRF ?? ???? POST requests
            if (token && settings.type !== 'GET') {
                xhr.setRequestHeader('X-CSRF-Token', token);
            }
        }
    });

    // Global AJAX Error Handler
    $(document).ajaxError(function (event, jqXHR, ajaxSettings, thrownError) {
        console.log('AJAX Error:', jqXHR.status, thrownError);

        // 401 Unauthorized - ???? ???? ????? ??? ???
        if (jqXHR.status === 401) {
            handleSessionExpired();
        }
        // 403 Forbidden - ?????? ???????
        else if (jqXHR.status === 403) {
            handleAccessDenied();
        }
    });

    // Global AJAX Success Handler ???? ????? ?????
    $(document).ajaxSuccess(function (event, xhr, settings) {
        // ????? ??? response ???? redirectUrl ???? (???? AJAX responses)
        if (xhr.responseJSON && xhr.responseJSON.redirectUrl) {
            window.location.href = xhr.responseJSON.redirectUrl;
        }
    });
});

/**
 * ?????? ????????? ???? ????
 */
function handleSessionExpired() {
    // ????? alert ??????
    if (confirm('???? ???? ??? ????? ??? ???.\n\n????? ???? ????? ??? ?????? ???? ????? ????.')) {
        // ????? ?? ???? ?????
        window.location.href = '/Identity/Account/Login';
    }
}

/**
 * ?????? ?????? ???????
 */
function handleAccessDenied() {
    alert('??? ?????? ?? ??? ??? ?? ??????.');
    // ?????? ?? ???? ???? ?? ???? ????
    if (document.referrer && document.referrer.indexOf(window.location.origin) === 0) {
        window.location.href = document.referrer;
    } else {
        window.location.href = '/Home/Index';
    }
}

/**
 * ????? ????? ???? ???? (??????? - ??????? ?? ??? ????? ???? ???)
 */
function checkSessionStatus() {
    $.ajax({
        url: '/Account/CheckSession',
        type: 'GET',
        success: function (response) {
            if (!response.isAuthenticated) {
                handleSessionExpired();
            }
        },
        error: function () {
            // ??? ?? ????? - ??????? ???? ???? ????
            console.warn('Cannot check session status');
        }
    });
}

// ???????: ????? ????? ???? ?? 15 ?????
// setInterval(checkSessionStatus, 15 * 60 * 1000);
