@using ERP.ViewModels.GoodsEntry
@using Kendo.Mvc.UI
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    var all = ViewBag.all;
    var s1 = ViewBag.s1;
    var s2 = ViewBag.s2;
    var s3 = ViewBag.s3;
    var s4 = ViewBag.s4;
    var s5 = ViewBag.s5;
    var s6 = ViewBag.s6;
    var s7 = ViewBag.s7;

}
<div class="app-title" style="display: flex; justify-content: space-between; align-items: center; padding: 0; margin: 0;">
    <h1><i class="fa fa-address-card-o" style="margin-left:10px;color:red"></i>لیست ورود کالا</h1>
    <button type="button" class="btn btn-primary" style="margin-right: 10px;" onclick="window.location.href='@Url.Action("GoodsEntryView", "GoodsEntry")'">
        <i class="fa fa-plus"></i> ورود کالا جدید
    </button>
</div>
<ul class="app-breadcrumb breadcrumb">
</ul>

<style>
    .k-grid-toolbar {
        direction: ltr;
    }

    .btn-icon {
        border-radius: 0 !important;
        padding: 0.1rem 0.3rem;
        color: white !important;
    }

    .asd {
        color: black !important;
        margin-right: 10px;
    }

    .modal-xl {
        max-width: 70%;
    }

    .swal-wide .swal2-popup {
        max-width: 90% !important;
        max-height: 80vh !important;
    }

    .swal-wide .swal2-html-container {
        overflow-y: auto;
    }

    .success {
        background-color: lawngreen !important;
    }

    .failed {
        background-color: lightcoral !important;
    }

    .yellow {
        background-color: #fbfb51 !important;
    }
</style>
@section styles
{
    <link href="~/sweetalert2/sweetalert2.min.css" rel="stylesheet" />
}
<div class="row" style="margin-bottom: 5px;">
    <div class="col-lg-12">
        <div class="tile" style="margin-bottom:0;">
            <div class="bs-component">
                <ul class="nav nav-tabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-toggle="tab" href="#tab1" onclick="SelectTab('BarrasiKala1')">
                            بررسی کالا <span class="badge badge-pill badge-warning">@ViewBag.s1</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#tab2" onclick="SelectTab('ControlKeyfiat2')">
                            کنترل کیفیت <span class="badge badge-pill badge-warning">@ViewBag.s2</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#tab3" onclick="SelectTab('TazminKeyfiat3')">
                            تضمین کیفیت <span class="badge badge-pill badge-warning">@ViewBag.s3</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#tab4" onclick="SelectTab('Other4')">
                            سایر <span class="badge badge-pill badge-warning">@ViewBag.s4</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#tab5" onclick="SelectTab('BarrasiSanaye5')">
                            بررسی صنایع <span class="badge badge-pill badge-warning">@ViewBag.s5</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#tab6" onclick="SelectTab('BaarasiTolid6')">
                            بررسی تولید <span class="badge badge-pill badge-warning">@ViewBag.s6</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#tab7" onclick="SelectTab('BaarasiKeyfiat7')">
                            بررسی کیفیت <span class="badge badge-pill badge-warning">@ViewBag.s7</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#tab8" onclick="SelectTab('Anbar8')">
                            انبار <span class="badge badge-pill badge-warning">@ViewBag.s8</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#tab9" onclick="SelectTab('End9')">
                            پایان <span class="badge badge-pill badge-warning">@ViewBag.s9</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="tab" href="#tabAll" onclick="SelectTab('همه لیست')">
                            همه لیست <span class="badge badge-pill badge-warning">@ViewBag.all</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="tile">
            <div class="k-rtl" style="overflow-x:auto;width:100%;">

                @(
                                Html.Kendo().Grid<IndexGoodsEntryViewModel>()
                                .Name("goodsentrygrid")
                                .Columns(col =>
                                {
                                    col.Bound(p => p.GoodsEntryID).Title("شناسه");
                                    col.Bound(p => p.State).Title("مرحله فعلی"); // نمایش مرحله
                                    col.Bound(p => p.TahvilDahande).Title("تحویل دهنده"); // نمایش مرحله
                                    col.Bound(p => p.S_persiandate).Title("تاریخ درخواست");
                                    col.Bound("").Title("اقلام کالا")
                                        .ClientTemplate(
                                            "<a href='javascript:void(0);' onclick='showGoodsItems(`#: GoodsEntryID #`, `#: Guid #`, this)' " +
                                            "class='btn btn-sm btn-outline-primary'>" +
                                            "<i class='fa fa-eye'></i> مشاهده</a>"
                                        );
                                    col.Bound(p => p.SourceTable).Title("منبع").Visible(false);
                                    col.Bound("").Title("عملیات").ClientTemplate(
                                    "<a type='button' class='btn btn-success btn-icon' href='/GoodsEntry/GoodsEntryView/#=GoodsEntryID#'>جزئیات</a>"
                                    + "<a type='button' class='btn btn-primary btn-icon' onclick='openHistoryModal(\"#=Guid#\")'>سوابق</a>"
                                    );

                                })
                                .ToolBar(toolbar =>
                                {
                                    toolbar.Search();
                                })
                                .Events(e => e.DataBound("onRowDataBound"))
                                .Sortable()
                                .Filterable()
                                .Pageable(pager => pager.AlwaysVisible(true).PageSizes(new int[] { 5, 10, 20, 100 }))
                                .DataSource(b => b.
                                Ajax()
                                .Read(read => read.Data("kendoDataBinding").Action("Data_GoodsEntry", "GoodsEntry"))
                                )
                                )
            </div>

        </div>
    </div>
</div>
<input id="guid" value="" type="hidden" />

<input type="hidden" id="selectedtab" value="همه لیست" />


<div class="modal fade" id="AttachModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">سوابق</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped table-hover" id="historyTable">
                        <thead class="table-danger">
                            <tr>
                                <th scope="col">فرستنده</th>
                                <th scope="col">گیرنده</th>
                                <th scope="col">عنوان</th>
                                <th scope="col">تاریخ ارسال</th>
                                <th scope="col">تاریخ مشاهده</th>
                            </tr>
                        </thead>
                        <tbody id="tableFile"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="close">بستن</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {

    <script src="~/sweetalert2/sweetalert2.js"></script>
    <script>
        function SelectTab(i) {
            $("#selectedtab").val(i);
            $("#goodsentrygrid").data("kendoGrid").dataSource.read();
        }
        function kendoDataBinding() {
            var SelectTab = $("#selectedtab").val();
            return { SelectTab: SelectTab }
        }
    </script>
    <script>
          function onRowDataBound(e) {
            const grid = $("#goodsentrygrid").data("kendoGrid");
            const rows = grid.tbody.find("tr");

            rows.each(function () {
                const dataItem = grid.dataItem(this);
                const result = (dataItem?.Progress || "").trim();

                if (result === 0) $(this).addClass("success");
                else if (result === 1) $(this).addClass("failed");
                else if (result === 2) $(this).addClass("yellow");
            });
        }
    </script>
    <script>
           function showGoodsItems(GoodsEntryID, Guid, el) {
            $.ajax({
                url: '/GoodsEntry/GetGoodsItems',  // نام اکشن رو با کدت تطبیق دادم
                type: 'GET',
                data: {
                    goodsEntryId: GoodsEntryID,
                    guid: Guid
                },
                success: function(data) {
                    if (data && data.length > 0) {
                        var tableHtml = `
                            <div style="text-align:center; font-size:18px; font-weight:bold; margin-bottom:10px;">
                                اقلام کالا - شناسه: <span style="color:red;">${GoodsEntryID}</span>
                            </div>
                            <hr>
                            <div style="direction:rtl; overflow-x:auto;">
                                <table class="table table-striped table-bordered" style="font-size:14px; width:100%;">
                                    <thead>
                                        <tr>
                                            <th>شرح کالا</th>
                                            <th>تعداد</th>
                                            <th>واحد</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        $.each(data, function(index, item) {
                            tableHtml += `
                                <tr>
                                    <td>${item.SharhKala || ''}</td>
                                    <td>${item.Tedad || ''}</td>
                                    <td>${item.Vahed || ''}</td>
                                </tr>
                            `;
                        });
                        tableHtml += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                        swal({
                            html: tableHtml,
                            confirmButtonText: 'بستن',
                        });
                    } else {
                        swal({
                            title: 'اطلاعات یافت نشد',
                            text: 'هیچ اقلامی برای این شناسه و GUID یافت نشد.',
                            type: 'warning',
                            confirmButtonText: 'بستن',
                        });
                    }
                },
                error: function(xhr, status, error) {
                    swal({
                        title: 'خطا',
                        text: 'خطا در بارگذاری اقلام: ' + error,
                        type: 'error',
                        confirmButtonText: 'بستن',
                    });
                }
            });
        }
    </script>
    <script>
            function History(Guid) {
            // var Guid = $("#Guid").val();

            $.ajax({
                type: "POST",
                url: "/GoodsEntry/History",
                contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
                data: { Guid: Guid },
                success: function (response) {
                    if (response.status === 'OK') {
                        $('#tableFile').empty();
                        if (response.data.length > 0) {
                            $.each(response.data, function (i, item) {
                                var markup = `<tr>
                                    <td>${item.SenderID}</td>
                                    <td>${item.ReceiverID}</td>
                                    <td>${item.Title}</td>
                                   <td>${item.SendDateTime}</td>
                                   <td>${item.ViewDateTime}</td>
                                </tr>`;
                                $("#tableFile").append(markup);
                            });
                            $("#historyTable").show();
                        } else {
                            $("#tableFile").append('<tr><td colspan="6" class="text-center">هیچ رکوردی یافت نشد</td></tr>');
                            $("#historyTable").show();
                        }
                    } else {
                        alert('خطایی رخ داده است. لطفاً دوباره تلاش کنید.');
                    }
                },
                error: function (xhr, status, error) {
                    alert('خطا در ارتباط با سرور: ' + error);
                }
            });
                $("#AttachModal").modal('show');
        }

        // تابع برای باز کردن مودال
        function openHistoryModal(guid) {
            History(guid);
        }
    </script>


}