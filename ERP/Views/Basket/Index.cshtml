@model ERP.ViewModels.Basket.BasketIndexViewModel

@{
    ViewData["Title"] = "سبد چک محصولات";
}

<h2 class="mt-4 mb-4">سبد چک محصولات</h2>

<!-- پیام‌ها -->
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show">
        <i class="fas fa-check-circle"></i> @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show">
        <i class="fas fa-exclamation-triangle"></i> @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<!-- فرم مخفی برای توکن -->
<form id="antiForgeryForm" style="display:none;">
    @Html.AntiForgeryToken()
</form>

<!-- تنظیمات ثابت -->
<div class="card mb-4 border-primary">
    <div class="card-header bg-primary text-white">
        <h5>تنظیمات ثابت</h5>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label"> انتخاب اپراتور</label>
                <select id="selectedUser" class="form-select" asp-items="@Model.AvailableUsers">
                    <option value="">-- انتخاب اپراتور --</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">مرحله فرآیند</label>
                <input type="text" id="stepProcedure" class="form-control" value="@Model.CurrentStepProcedure" />
            </div>
            <div class="col-md-4">
                <label class="form-label">شماره دستگاه</label>
                <input type="text" id="numberDevice" class="form-control" value="@Model.CurrentNumberDevice" />
            </div>
        </div>
        <div class="mt-3">
            <button type="button" id="startScanning" class="btn btn-success btn-lg">
                <i class="fas fa-barcode"></i> شروع اسکن بارکد
            </button>
        </div>
    </div>
</div>

<!-- بخش اسکن -->
<div class="card mb-4" id="scanSection" style="display:none;">
    <div class="card-header bg-success text-white">
        <h5>اسکن فعال</h5>
    </div>
    <div class="card-body text-center">
        <p class="lead">بارکدخوان آماده است.</p>
        <div class="mb-3">
            <strong>کاربر:</strong> <span id="displayUser"></span> |
            <strong>مرحله:</strong> <span id="displayStep"></span> |
            <strong>دستگاه:</strong> <span id="displayDevice"></span>
        </div>
        <input type="text" id="barcodeInput" class="form-control form-control-lg text-center" autofocus />
            <button type="button" id="stopScanning" class="btn btn-warning btn-lg mt-3">
            <i class="fas fa-stop"></i> توقف اسکن
        </button>
    </div>
</div>

<!-- جدول سبد -->
@if (Model.Basket?.basketCheckItems?.Any() == true)
{
    <h4 class="mt-5">محصولات در سبد (@Model.Basket.basketCheckItems.Count)</h4>
    <div class="table-responsive">
        <table class="table table-striped">
            <thead class="table-dark">
                <tr>
                    <th>سریال</th>
                    <th>تاریخ</th>
                    <th>مرحله</th>
                    <th>دستگاه</th>
                    <th>انتخاب اپراتور</th>
                    <th>حذف</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Basket.basketCheckItems)
                {
                    <tr>
                        
                        <td><strong>@item.Serial_Product</strong></td>
                        <td>@item.DateGenerate.ToString("yyyy/MM/dd")</td>
                        <td>@item.Step_Procedure</td>
                        <td>@item.Number_Device</td>
                        <td>@item.UserName</td>
                        <td>
                         <form asp-action="RemoveItem" method="post" style="display:inline;">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="serialProduct" value="@item.Serial_Product" />
                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('حذف شود؟');">
                            <i class="fas fa-trash"></i>
                        </button>
                    </form>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="mt-4">
        <form asp-action="FinalizeBasket" method="post" style="display:inline;">
            @Html.AntiForgeryToken()
            <button type="submit" class="btn btn-success btn-lg">
                <i class="fas fa-database"></i> ذخیره در SQL
            </button>
        </form>
        <form asp-action="Clear" method="post" style="display:inline;">
            @Html.AntiForgeryToken()
            <button type="submit" class="btn btn-danger btn-lg ms-3"
                    onclick="return confirm('کل سبد پاک شود؟');">
                <i class="fas fa-broom"></i> پاک کردن سبد
            </button>
        </form>
    </div>
}
else
{
    <div class="alert alert-info mt-4">
        سبد خالی است.
    </div>
}

@section Scripts {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script>
        function getToken() {
            return document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
        }

        const userSelect = document.getElementById('selectedUser');
        const stepInput = document.getElementById('stepProcedure');
        const deviceInput = document.getElementById('numberDevice');
        const startBtn = document.getElementById('startScanning');
        const scanSection = document.getElementById('scanSection');
        const barcodeInput = document.getElementById('barcodeInput');
        const stopBtn = document.getElementById('stopScanning');
        const displayUser = document.getElementById('displayUser');
        const displayStep = document.getElementById('displayStep');
        const displayDevice = document.getElementById('displayDevice');

        // شروع اسکن
        startBtn.addEventListener('click', () => {
            if (!userSelect.value || !stepInput.value.trim() || !deviceInput.value.trim()) {
                alert('لطفاً همه فیلدها را پر کنید');
                return;
            }
            displayUser.textContent = userSelect.options[userSelect.selectedIndex].text;
            displayStep.textContent = stepInput.value;
            displayDevice.textContent = deviceInput.value;
            scanSection.style.display = 'block';
            barcodeInput.focus();
        });

        // توقف اسکن
        stopBtn.addEventListener('click', () => {
            scanSection.style.display = 'none';
            barcodeInput.value = '';
        });

        // اسکن و افزودن
        barcodeInput.addEventListener('keyup', e => {
            if (e.key === 'Enter') addItem();
        });
        barcodeInput.addEventListener('change', addItem);

       function addItem() {
    const serial = barcodeInput.value.trim();
    if (!serial) return;

    fetch('@Url.Action("AddScannedItem")', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'RequestVerificationToken': getToken()
        },
        body: JSON.stringify({
            serialProduct: serial,  // دیگر parseInt نکنید، مستقیم string بفرستید
            userName: userSelect.value,
            stepProcedure: stepInput.value.trim(),
            numberDevice: deviceInput.value.trim()
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || 'خطا');
        }
    });

    barcodeInput.value = '';
    barcodeInput.focus();
}

        // اگر قبلاً تنظیمات وجود داشت، مستقیم اسکن فعال شود
        if ("@Model.CurrentUserName" && "@Model.CurrentStepProcedure" && "@Model.CurrentNumberDevice") {
            userSelect.value = "@Model.CurrentUserName";
            stepInput.value = "@Model.CurrentStepProcedure";
            deviceInput.value = "@Model.CurrentNumberDevice";
            startBtn.click(); // خودکار شروع اسکن
        }
    </script>
}