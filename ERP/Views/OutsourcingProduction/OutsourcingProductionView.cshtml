@using Kendo.Mvc.UI
@using System.Security.Claims
@model ERP.Models.OutsourcingProduction

@{
    var guid = ViewBag.Guid;
    var workflowInstance = ViewBag.WorkflowInstance as ERP.Models.WorkflowInstance;
    var currentState = Model?.State ?? "start0";
    var canEdit = ViewBag.CanEdit ?? false;
    var isObserver = ViewBag.IsObserver ?? false;
    var isSuccessfulCompletion = ViewBag.IsSuccessfulCompletion ?? false;
    var endReason = ViewBag.EndReason ?? "";
    var workflowSteps = ViewBag.WorkflowSteps as List<ERP.Models.WorkflowStep>;

    var completedSections = new List<string>();
    if (workflowInstance != null)
    {
        var history = ViewBag.WorkflowHistory as List<ERP.Models.WorkflowInstance>;
        if (history != null)
        {
            completedSections = history
                .Where(w => w.IsCompleted)
                .OrderBy(w => w.AssignedDate)
                .Select(w => w.Section)
                .Distinct()
                .ToList();
        }
    }
    else if (currentState == "start0")
    {
        completedSections.Add("start0");
    }
}
<div class="app-title">
    <div>
        <h1><i class="fa fa-inbox" style="margin-left:10px;color:red"></i><span>برونسپاری تولید</span><span class="id-card">@Model.OutsourcingProductionID</span> </h1>
    </div>
    <ul class="app-breadcrumb breadcrumb"></ul>
</div>

<input type="hidden" asp-for="OutsourcingProductionID" id="OutsourcingProductionID" />
<input type="hidden" value="@guid" name="Guid" id="Guid" />

<div class="row justify-content-center align-items-center">
    <div class="col-md-9">
        <div class="tile">
            <!-- مرحله اول -->
            @if ((completedSections.Contains("start0") && (canEdit || isObserver)) || (currentState == "start0" && (canEdit)))
            {
                <div class="card shadow-sm" id="section1" @(canEdit && currentState == "start0" ? "" : "style='pointer-events: none; opacity: 0.7;'")>
                    <div class="card-header bg-info text-white text-center">
                        <h5 class="mb-0">درخواست برونسپاری تولید</h5>
                    </div>
                    <div class="card-body">
                        <form id="form1" novalidate>
                            <div class="form-row">
                                <div class="form-group col-md-2">
                                    <label asp-for="S_persiandate" class="font-weight-bold">تاریخ درخواست</label>
                                    <input asp-for="S_persiandate" class="form-control" data-jdp disabled autocomplete="off" />
                                </div>
                                <div class="form-group col-md-2">
                                    <label asp-for="Shomare_Serial" class="font-weight-bold">شماره سریال</label>
                                    <input asp-for="Shomare_Serial" class="form-control" data-parsley-required="true" data-parsley-required-message="فیلد خالی است" disabled="@(!canEdit)" autocomplete="off" />
                                </div>
                                <div class="form-group col-md-3">
                                    <label asp-for="MahalDaryaft" class="font-weight-bold">محل دریافت</label>
                                    <input asp-for="MahalDaryaft" class="form-control" data-parsley-required="true" data-parsley-required-message="فیلد خالی است" disabled="@(!canEdit)" autocomplete="off" />
                                </div>
                                <div class="form-group col-md-3">
                                    <label asp-for="Name_Darkhastkonnande" class="font-weight-bold">نام درخواست کننده</label>
                                    <input asp-for="Name_Darkhastkonnande" class="form-control" data-parsley-required="true" data-parsley-required-message="فیلد خالی است" disabled="@(!canEdit)" autocomplete="off" />
                                </div>
                                <div class="form-group col-md-2">
                                    <label asp-for="Darkhast_persiandate" class="font-weight-bold">تاریخ ارسال</label>
                                    <input asp-for="Darkhast_persiandate" class="form-control" data-jdp data-parsley-required="true" data-parsley-required-message="فیلد خالی است" disabled="@(!canEdit)" autocomplete="off" />
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="col-md-12">
                                    <label class="font-weight-bold">اقلام برونسپاری</label>
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover" id="GoodsTable">
                                            <thead class="thead-light">
                                                <tr>
                                                    <th>شرح</th>
                                                    <th>تعداد</th>
                                                    <th>علت</th>
                                                    @if (currentState == "start0" && canEdit)
                                                    {
                                                        <th>عملیات</th>
                                                    }
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @if (Model?.OutsourcingItems != null && Model.OutsourcingItems.Any())
                                                {
                                                    int rowIndex = 0;
                                                    foreach (var guest in Model.OutsourcingItems)
                                                    {
                                                        <tr>
                                                            @if (currentState == "start0" && canEdit)
                                                            {
                                                                <td><input type="text" name="Goods[@rowIndex].ItemName" value="@guest.ItemName" class="form-control" data-parsley-required="true" data-parsley-required-message="شرح الزامی است" /></td>
                                                                <td><input type="number" name="Goods[@rowIndex].Quantity" value="@guest.Quantity" class="form-control" data-parsley-required="true" data-parsley-required-message="تعداد الزامی است" min="1" /></td>
                                                                <td><input type="text" name="Goods[@rowIndex].Description" value="@guest.Description" class="form-control" data-parsley-required="true" data-parsley-required-message="علت الزامی است" /></td>
                                                                <td><button type="button" class="btn btn-sm btn-danger" onclick="this.closest('tr').remove(); recalculateIndex();">حذف</button></td>
                                                            }
                                                            else
                                                            {
                                                                <td>@guest.ItemName</td>
                                                                <td>@guest.Quantity</td>
                                                                <td>@guest.Description</td>
                                                            }
                                                        </tr>
                                                        rowIndex++;
                                                    }
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                    @if (currentState == "start0" && canEdit)
                                    {
                                        <button type="button" class="btn btn-sm btn-success mt-2" onclick="addGoods()">افزودن</button>
                                    }
                                </div>
                            </div>

                            @if (currentState == "start0" && canEdit)
                            {
                                <div class="row justify-content-center">
                                    <div class="form-group col-md-6">
                                        <label class="control-label">انتخاب مدیر</label>
                                        <select class="form-control select2" id="ManagerUserID" name="ManagerUserID">
                                            <option value="">لطفاً مدیر را انتخاب کنید</option>
                                        </select>
                                    </div>
                                </div>
                            }

                            <div class="text-center mt-4">
                                @if (currentState == "start0" && canEdit)
                                {
                                    <button type="submit" class="btn btn-primary btn-lg">ثبت</button>
                                }
                            </div>
                            <div id="message1" class="mt-3 text-center"></div>
                        </form>
                    </div>
                </div>
            }

            <!-- فرم مرحله دوم (تأیید مسئول) -->
            @* ادامه‌ی بخش‌ها و فرم‌ها عینِ GoodsConsigned است، فقط actionها را تغییر داده‌ام *@

            @if ((completedSections.Contains("TayidMasool1") && (canEdit || isObserver)) || (currentState == "TayidMasool1" && canEdit))
            {
                <div class="card shadow-sm mt-4" id="section2" @(canEdit && currentState == "TayidMasool1" ? "" : "style='pointer-events: none; opacity: 0.7;'")>
                    <div class="card-header bg-warning text-white text-center">
                        <h5 class="mb-0">تأیید مسئول</h5>
                    </div>
                    <div class="card-body">
                        <form id="form2" novalidate>
                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label class="font-weight-bold">مورد تأیید است؟</label><br>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input sq" type="radio" asp-for="TayidMasool" value="0" disabled="@(!canEdit)">
                                        <label class="form-check-label sq">بله</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input sq" type="radio" asp-for="TayidMasool" value="1" disabled="@(!canEdit)">
                                        <label class="form-check-label sq">خیر</label>
                                    </div>
                                    <span id="taeedError" class="text-danger"></span>
                                </div>
                                <div class="form-group col-md-6">
                                    <label asp-for="Tozihat_Masool" class="font-weight-bold">توضیحات</label>
                                    <textarea asp-for="Tozihat_Masool" class="form-control" rows="5" disabled="@(!canEdit)"></textarea>
                                </div>
                            </div>

                            <div class="text-center mt-4">
                                @if (currentState == "TayidMasool1" && canEdit)
                                {
                                    <button type="submit" class="btn btn-primary btn-lg">ثبت</button>
                                }
                            </div>
                            <div id="message2" class="mt-3 text-center"></div>
                        </form>
                    </div>
                </div>
            }

            <!-- سایر فرم‌ها (عین GoodsConsigned) -->
            @* برای اختصار تمام بلوک‌های فرم‌ها را 그대로 کپی کنید و در AJAX‌ها مسیرها را به OutsourcingProduction تغییر دهید. *@

        </div>
    </div>
</div>

<a onclick='openHistoryModal()' class="floating-help-left2">سوابق <i class="icon-spaced"></i></a>
<a href="javascript:void(0)" onclick="goBackAndRefresh()" class="floating-help-left">بازگشت <i class="fa fa-arrow-left icon-spaced"></i></a>

<div class="modal fade" id="AttachModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">سوابق</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped table-hover" id="historyTable">
                        <thead class="table-danger">
                            <tr>
                                <th scope="col">فرستنده</th>
                                <th scope="col">گیرنده</th>
                                <th scope="col">عنوان</th>
                                <th scope="col">تاریخ ارسال</th>
                                <th scope="col">تاریخ مشاهده</th>
                            </tr>
                        </thead>
                        <tbody id="tableFile2"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="close">بستن</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/jalalidatepicker/jalalidatepicker.min.js"></script>
    <script src="~/Parsley/parsley.min.js"></script>
    <script src="~/select 2/select 2.js"></script>
    <script>
        jalaliDatepicker.startWatch();
    </script>

    <script>
        // بازسازی index بعد از حذف ردیف
        function recalculateIndex() {
            const rows = document.querySelectorAll('#GoodsTable tbody tr');
            rows.forEach((row, index) => {
                const inputs = row.querySelectorAll('input');
                if (inputs.length >= 3) {
                    inputs[0].name = `Goods[${index}].ItemName`;
                    inputs[1].name = `Goods[${index}].Quantity`;
                    inputs[2].name = `Goods[${index}].Description`;
                }
            });
            goodIndex = rows.length;
        }

        let goodIndex = 0;
        function addGoods() {
            const table = document.getElementById('GoodsTable').getElementsByTagName('tbody')[0];
            const row = table.insertRow();
            const cell1 = row.insertCell(0);
            const cell2 = row.insertCell(1);
            const cell3 = row.insertCell(2);
            const cell4 = row.insertCell(3);

            cell1.innerHTML = `<input type="text" name="Goods[\${goodIndex}].ItemName" class="form-control" data-parsley-required="true" data-parsley-required-message="شرح الزامی است" />`;
            cell2.innerHTML = `<input type="number" name="Goods[\${goodIndex}].Quantity" class="form-control" data-parsley-required="true" data-parsley-required-message="تعداد الزامی است" min="1" />`;
            cell3.innerHTML = `<input type="text" name="Goods[\${goodIndex}].Description" class="form-control" data-parsley-required="true" data-parsley-required-message="علت الزامی است" />`;
            cell4.innerHTML = `<button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove(); recalculateIndex();">حذف</button>`;

            goodIndex++;
        }

        document.addEventListener('DOMContentLoaded', function() {
            if ('@currentState' === 'start0' && '@canEdit' === 'True') {
                addGoods();
            }
        });
    </script>

    <script>
        // ارسال فرم مرحله اول
        $('#form1').on('submit', function (e) {
            e.preventDefault();
            let $btn = $(this).find('[type=submit]');
            $btn.prop('disabled', true).text('در حال ارسال...');

            if (!$(this).parsley().validate()) {
                $btn.prop('disabled', false).text('ثبت');
                return;
            }

            const GoodsRows = $('#GoodsTable tbody tr');
            let hasValidGoods = false;
            let invalidCount = 0;
            GoodsRows.each(function () {
                const ItemName = $(this).find('input[name^="Goods"][name$=".ItemName"]').val();
                const Quantity = $(this).find('input[name^="Goods"][name$=".Quantity"]').val();
                const Description = $(this).find('input[name^="Goods"][name$=".Description"]').val();

                if (ItemName && Quantity && Description && !isNaN(parseInt(Quantity)) && parseInt(Quantity) > 0) {
                    hasValidGoods = true;
                } else {
                    invalidCount++;
                }
            });

            if (!hasValidGoods) {
                $('#message1').text(`لطفاً ${invalidCount > 0 ? invalidCount + ' ' : ''}ردیف کالا را با اطلاعات معتبر کامل کنید.`).addClass('text-danger');
                $btn.prop('disabled', false).text('ثبت');
                return;
            } else {
                $('#message1').text('').removeClass('text-danger');
            }

            if (!$('#ManagerUserID').val()) {
                $('#message1').text('لطفاً مدیر واحد را انتخاب کنید.').addClass('text-danger');
                $btn.prop('disabled', false).text('ارسال');
                return;
            }

            const formData = {
                OutsourcingProductionID: $('#OutsourcingProductionID').val(),
                S_persiandate: $('#S_persiandate').val(),
                Shomare_Serial: $('#Shomare_Serial').val(),
                MahalDaryaft: $('#MahalDaryaft').val(),
                Darkhast_persiandate: $('#Darkhast_persiandate').val(),
                Name_Darkhastkonnande: $('#Name_Darkhastkonnande').val(),
                ManagerUserID:  $('#ManagerUserID').val(),
                Guid: $('#Guid').val(),
                Goods: []
            };

            $('#GoodsTable tbody tr').each(function() {
                const ItemName = $(this).find('input[name^="Goods"][name$=".ItemName"]').val();
                const Quantity = $(this).find('input[name^="Goods"][name$=".Quantity"]').val();
                const Description = $(this).find('input[name^="Goods"][name$=".Description"]').val();
                if (ItemName && Quantity && Description && !isNaN(parseInt(Quantity)) && parseInt(Quantity) > 0) {
                    formData.Goods.push({
                        ItemName: ItemName,
                        Quantity: parseInt(Quantity),
                        Description: Description
                    });
                }
            });

            $.ajax({
                url: '/OutsourcingProduction/SaveForm1',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function (response) {
                    if (response.success === false) {
                        $('#message1').text(response.message).removeClass().addClass('text-danger');
                        $btn.prop('disabled', false).text('ثبت');
                        return;
                    }
                    window.location.href = '@Url.Action("Index", "OutsourcingProduction")';
                },
                error: function(xhr, status, error) {
                    $('#message1').text('خطا در ارتباط با سرور.').addClass('text-danger');
                    $btn.prop('disabled', false).text('ثبت');
                }
            });
        });
    </script>

    <script>
        // ارسال فرم‌ها برای مراحل بعدی — مسیرها به OutsourcingProduction تغییر کرد
        $('#form2').on('submit', function (e) {
            e.preventDefault();
            if ($(this).parsley().validate()) {
                let $btn = $(this).find('[type=submit]');
                $btn.prop('disabled', true).text('در حال ارسال...');

                const formData = {
                    OutsourcingProductionID: $('#OutsourcingProductionID').val(),
                    TayidMasool: $("#TayidMasool").val(),
                    Tozihat_Masool: $('#Tozihat_Masool').val(),
                    Guid: $('#Guid').val()
                };

                $.ajax({
                    url: '/OutsourcingProduction/SaveForm2',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function (response) {
                        if (response.success === false) {
                            $('#message2').text(response.message).removeClass().addClass('text-danger');
                            $btn.prop('disabled', false).text('ثبت');
                            return;
                        }
                        window.location.href = '@Url.Action("Index", "OutsourcingProduction")';
                    },
                    error: function() {
                        $('#message2').text('خطا در ارتباط با سرور.').addClass('text-danger');
                        $btn.prop('disabled', false).text('ثبت');
                    }
                });
            }
        });

        // مشابه بالا: فرم‌های 3..9 را عیناً از GoodsConsigned کپی کن و مسیرهای AJAX را به /OutsourcingProduction/SaveForm3 ... SaveForm9 تغییر بده
    </script>

    <script>
        function openHistoryModal() {
            var Guid = $("#Guid").val();
            $.ajax({
                type: "POST",
                url: "/OutsourcingProduction/History",
                contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
                data: { Guid: Guid },
                success: function (response) {
                    if (response.status === 'OK') {
                        $('#tableFile2').empty();
                        if (response.data.length > 0) {
                            $.each(response.data, function (i, item) {
                                var markup = `<tr>
                                    <td>${item.SenderID}</td>
                                    <td>${item.ReceiverID}</td>
                                    <td>${item.Title}</td>
                                    <td>${item.SendDateTime}</td>
                                    <td>${item.ViewDateTime}</td>
                                </tr>`;
                                $("#tableFile2").append(markup);
                            });
                            $("#historyTable").show();
                        } else {
                            $("#tableFile2").append('<tr><td colspan="6" class="text-center">هیچ رکوردی یافت نشد</td></tr>');
                            $("#historyTable").show();
                        }
                    }
                    $("#AttachModal").modal('show');
                },
                error: function (xhr, status, error) {
                    alert('خطا در ارتباط با سرور: ' + error);
                }
            });
        }
    </script>
}